<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>S.A.L.T</title>
    <link rel="stylesheet" href="index.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- PWA and Mobile App Meta Tags -->
    <meta name="theme-color" content="#6A89A4">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="S.A.L.T">
</head>
<body>
    <div id="login-overlay" class="active">
        <div id="login-modal">
            <img src="logo.svg" alt="S.A.L.T Logo" class="login-logo">
            <h2>S.A.L.T</h2>
            <p class="login-subtitle">Sharing And Living Together.</p>
            <form id="login-form">
                <div class="test-account-hint">
                    <p>Tap a number to test:</p>
                    <div class="test-numbers">
                        <button type="button" class="test-number-chip" data-phone="9800000001">9800000001</button>
                        <button type="button" class="test-number-chip" data-phone="9800000002">9800000002</button>
                        <button type="button" class="test-number-chip" data-phone="1234">1234</button>
                    </div>
                </div>
                <div id="login-step-1">
                    <input type="tel" id="phone-input" placeholder="Phone Number" required autocomplete="tel">
                    <button type="submit" id="send-code-btn" class="login-btn">Sign In</button>
                </div>
                 <p id="login-error"></p>
            </form>
        </div>
    </div>


    <!-- Group Members Modal -->
    <div id="group-members-overlay" class="modal-overlay hidden">
        <div id="group-members-modal" class="modal-content">
            <h3>Group Members</h3>
            <ul id="group-members-list">
                <!-- Members will be populated by JS -->
            </ul>
            <button id="close-group-members-modal" class="modal-close-btn">Close</button>
        </div>
    </div>
    
    <!-- Admin Panel Overlay -->
    <div id="admin-panel-overlay" class="modal-overlay hidden">
        <div class="admin-panel">
             <div class="admin-header">
                <h2>Admin Panel</h2>
                <button id="exit-admin-mode-btn">&times;</button>
            </div>
            <div class="admin-content">
                <div class="admin-section">
                    <h3>Manage Members</h3>
                    <ul id="admin-members-list" class="admin-list"></ul>
                </div>
                 <div class="admin-section">
                    <h3>Manage Prayers</h3>
                    <ul id="admin-prayers-list" class="admin-list"></ul>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container">
        <header>
            <!-- This button is removed as logout is in the 'more' menu now -->
            <div style="width: 40px;"></div> <!-- Spacer -->
            <h1 id="header-title">Welcome</h1>
            <div class="header-actions">
                <button id="notification-btn" aria-label="Notifications">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
                    <span id="notification-badge" class="hidden"></span>
                </button>
                <button id="more-menu-btn" aria-label="More options">
                     <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                </button>
                <div id="more-menu-dropdown" class="dropdown-menu hidden">
                    <button id="dropdown-admin-btn">Admin Mode</button>
                    <button id="dropdown-logout-btn">Logout</button>
                </div>
            </div>
        </header>
        <div id="notification-panel" class="hidden">
            <ul id="notification-list">
                <!-- Notifications will be populated by JS -->
            </ul>
        </div>

        <main>
            <!-- Welcome Section -->
            <section id="welcome" class="content-section active">
                <div id="welcome-hero">
                     <img src="https://images.unsplash.com/photo-1508361001413-762174338279?q=80&w=2070&auto=format&fit=crop" alt="Church community" />
                    <div class="hero-content">
                        <h2 id="welcome-church-name">Welcome!</h2>
                        <p id="welcome-message">Please select a church to get started.</p>
                    </div>
                </div>
                <div class="page-padding">
                    <!-- Other welcome content can go here in cards -->
                </div>
            </section>

            <!-- Live Service Section -->
            <section id="live" class="content-section">
                <div class="card">
                    <h2>‡§Ü‡§∞‡§ß‡§®‡§æ</h2>
                    <div class="video-player-container">
                        <iframe id="video-player"
                                src=""
                                title="YouTube video player"
                                frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                allowfullscreen>
                        </iframe>
                    </div>
                    <h3>Past Sermons (Last 30 days)</h3>
                    <ul id="sermon-list" class="sermon-list">
                        <!-- Sermon list will be populated by JS -->
                    </ul>
                </div>
            </section>

            <!-- Prayer Requests Section -->
            <section id="prayer" class="content-section">
                <div class="page-padding">
                    <h2>‡§™‡•ç‡§∞‡§æ‡§∞‡•ç‡§•‡§®‡§æ</h2>
                    <div class="card">
                        <form id="prayer-form">
                            <input type="text" id="prayer-title-input" placeholder="Prayer Title" required aria-label="Prayer Title">
                            <textarea id="prayer-input" placeholder="Share your prayer request..." required aria-label="New prayer request"></textarea>
                            <input type="file" id="prayer-image-input" accept="image/*" aria-label="Upload an image">
                            <label for="prayer-image-input" class="file-input-label">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M21.41,5.59l-4.17-4.17C16.83,1,16.2,1,15.83,1.41L3.41,13.83c-0.39,0.39-0.39,1.02,0,1.41l4.17,4.17c0.39,0.39,1.02,0.39,1.41,0l12.41-12.41C21.8,6.61,21.8,5.97,21.41,5.59z M10,17.25V14l-2.25,2.25L10,17.25z M14,10h-4v4l-2-2L4.75,15.25l-1.5-1.5L6.5,10.5l-2-2l3.25-3.25l2,2H14V10z"/></svg>
                                <span>Add Photo (Optional)</span>
                                <span id="prayer-image-filename"></span>
                            </label>
                            <button type="submit">Post Prayer</button>
                        </form>
                    </div>
                    <div id="prayer-list">
                        <!-- Prayers will be populated by JS -->
                    </div>
                </div>
            </section>
            
            <!-- Bible Section -->
            <section id="bible" class="content-section">
                <div class="page-padding">
                    <h2>‡§¨‡§æ‡§á‡§¨‡§≤</h2>
                    <div class="card">
                        <h3>üìñ Daily Life (‡§¶‡•à‡§®‡§ø‡§ï ‡§ú‡•Ä‡§µ‡§®)</h3>
                        <p id="daily-life-content">‡§Ü‡§ú‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§≠‡§ï‡•ç‡§§‡§ø‡§Æ‡§Ø ‡§∏‡§®‡•ç‡§¶‡•á‡§∂ ‡§Ø‡§π‡§æ‡§Å ‡§≤‡•ã‡§° ‡§π‡•Å‡§®‡•á‡§õ‡•§ (Today's devotional message will be loaded here.)</p>
                        <span class="news-date" id="daily-life-date"></span>
                    </div>
                    <div class="card">
                        <h3>Bible Reading Plan (‡§è‡§ï ‡§µ‡§∞‡•ç‡§∑‡§Æ‡§æ ‡§¨‡§æ‡§á‡§¨‡§≤ ‡§™‡§¢‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç)</h3>
                        <div id="bible-reading-plan">
                            <!-- Reading plan will be populated by JS -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Church News Section -->
            <section id="news" class="content-section">
                 <div class="page-padding">
                    <h2>‡§∏‡•Å‡§ö‡§®‡§æ</h2>
                    <div id="news-list">
                        <!-- News items will be populated by JS -->
                    </div>
                </div>
            </section>

            <!-- Chat Section -->
            <section id="chat" class="content-section">
                <!-- Chat List View -->
                <div id="chat-list-view" class="active">
                    <div id="chat-list-container">
                        <!-- Chat list items will be populated by JS -->
                    </div>
                    <button id="new-chat-fab" class="fab" aria-label="New chat">+</button>
                </div>

                <!-- Chat Detail View -->
                <div id="chat-detail-view">
                    <div class="chat-header">
                        <button id="chat-back-btn" aria-label="Back to chat list">&lt;</button>
                        <h3 id="chat-detail-title"></h3>
                    </div>
                    <div class="chat-messages">
                        <!-- Messages will be added here -->
                    </div>
                    <div class="chat-input-area">
                        <button class="chat-action-btn" aria-label="Attach file">üìé</button>
                        <textarea id="chat-input" placeholder="Type a message..." aria-label="Chat message input" rows="1"></textarea>
                        <button id="emoji-btn" class="chat-action-btn" aria-label="Send emoji">üòÄ</button>
                        <button id="chat-send-btn" class="chat-action-btn" aria-label="Send message">‚û§</button>
                    </div>
                    <div id="emoji-picker" class="emoji-picker">
                        <!-- Emojis will be populated by JS -->
                    </div>
                </div>

                <!-- New Chat User Selection View -->
                <div id="new-chat-view">
                     <div class="chat-header">
                        <button id="new-chat-back-btn" aria-label="Back to chat list">&lt;</button>
                        <h3>New Chat</h3>
                    </div>
                    <div class="search-container">
                        <input type="search" id="user-search-input" placeholder="Search for people...">
                    </div>
                    <div id="user-list-container">
                        <!-- User list will be populated by JS -->
                    </div>
                </div>
            </section>
        </main>

        <nav class="bottom-nav">
            <button class="nav-item active" data-target="welcome" aria-label="Welcome">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                <span>‡§∏‡•ç‡§µ‡§æ‡§ó‡§§‡§Æ</span>
            </button>
            <button class="nav-item" data-target="live" aria-label="Live Service">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                <span>‡§Ü‡§∞‡§ß‡§®‡§æ</span>
            </button>
            <button class="nav-item" data-target="news" aria-label="Church News">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM8 17H6v-2h2v2zm0-4H6v-2h2v2zm0-4H6V7h2v2zm10 8h-8v-2h8v2zm0-4h-8v-2h8v2zm0-4h-8V7h8v2z"/></svg>
                <span>‡§∏‡•Å‡§ö‡§®‡§æ</span>
            </button>
            <button class="nav-item" data-target="bible" aria-label="Bible">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
                <span>‡§¨‡§æ‡§á‡§¨‡§≤</span>
            </button>
            <button class="nav-item" data-target="prayer" aria-label="Prayer Requests">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-3.5 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-3.5 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-3.5 0C4.9 6 4 6.9 4 8s.9 2 2 2 2-.9 2-2-.9-2-2-2zM4 14.5c0-.83.67-1.5 1.5-1.5h13c.83 0 1.5.67 1.5 1.5v.5h-16v-.5zM20 18H4v-1.5h16V18zM4 21.5h16V20H4v1.5z"/></svg>
                <span>‡§™‡•ç‡§∞‡§æ‡§∞‡•ç‡§•‡§®‡§æ</span>
            </button>
            <button class="nav-item" data-target="chat" aria-label="Chat">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                <span>‡§∏‡§Ç‡§ó‡§§‡§ø</span>
            </button>
        </nav>
    </div>
    
    <script>
    // --- APP LOGIC INLINED TO FIX LOADING ISSUES ---

    const mockUsers = {
        '9800000001': { userId: 'user1', churchId: 'grace-church', name: 'Admin User' },
        '9800000002': { userId: 'user5', churchId: 'hope-fellowship', name: 'Pastor David' },
        '1234': { userId: 'user1', churchId: 'grace-church', name: 'Admin User (Test)' }
    };

    const mockDatabase = {
        'grace-church': {
            name: 'Grace Community Church',
            welcomeMessage: 'We are so glad you\'re here. Our community is a place where you can find love, hope, and a family in Christ.',
            liveServiceVideoId: '5qap5aO4i9A',
            members: [
                { id: 'user1', name: 'Admin User', isAdmin: true, avatarColor: '#3f51b5' },
                { id: 'user2', name: 'Pastor John', isAdmin: false, avatarColor: '#e91e63' },
                { id: 'user3', name: 'Jane Doe', isAdmin: false, avatarColor: '#009688' },
                { id: 'user4', name: 'Mike Smith', isAdmin: false, avatarColor: '#ff9800' },
            ],
            sermons: [{ videoId: 'Y-i4p4O7a_0', title: 'The Courage to Hope', speaker: 'Pastor John', date: '2024-05-19' }, { videoId: 'jNQXAC9IVRw', title: 'Love That Transforms', speaker: 'Pastor Jane', date: '2024-05-12' }],
            prayers: [{ id: 'p1', postedBy: 'user3', timestamp: '2024-05-20T10:00:00Z', title: 'Family Health', text: 'Please pray for my family\'s health and protection.', prayedCount: 12, comments: [], image: null }],
            news: [{ title: 'Summer Retreat Registration Open', text: 'Registration for the annual summer retreat is now open! Sign up by June 15th.', date: 'May 15, 2024' }],
            chats: [
                { id: 'chat1', name: 'Youth Group', type: 'group', members: ['user1', 'user3', 'user4'], preview: 'Sounds good, see you there!', time: '3:45 PM', avatarColor: '#e91e63' },
                { id: 'chat2', name: 'Pastor John', type: 'direct', members: ['user1', 'user2'], preview: 'Can we meet tomorrow?', time: '1:12 PM', avatarColor: '#3f51b5' },
            ]
        },
        'hope-fellowship': {
            name: 'Hope Fellowship Nepal',
            welcomeMessage: 'Welcome to Hope Fellowship! A place to grow together in faith and love. We are delighted to have you with us.',
            liveServiceVideoId: 'tSBFz_MDnLs',
            members: [
                { id: 'user5', name: 'Pastor David', isAdmin: true, avatarColor: '#009688' },
                { id: 'user6', name: 'Sarah Lee', isAdmin: false, avatarColor: '#e91e63' },
            ],
            sermons: [{ videoId: 'tSBFz_MDnLs', title: 'Walking in the Light', speaker: 'Pastor David', date: '2024-05-05' }, { videoId: 'w5kM5w_2q2c', title: 'The Heart of a Servant', speaker: 'Pastor David', date: '2024-04-28' }],
            prayers: [{ id: 'p2', postedBy: 'user6', timestamp: '2024-05-21T14:30:00Z', title: 'New Job Guidance', text: 'Praying for wisdom and guidance in my new job.', prayedCount: 8, comments: [], image: null }],
            news: [{ title: 'VBS Volunteers Needed', text: 'We are looking for volunteers for this year\'s Vacation Bible School. Please see Sarah for more info.', date: 'May 12, 2024' }],
            chats: [{ id: 'chat3', name: 'Sunday School Teachers', type: 'group', members: ['user5', 'user6'], preview: 'Who is bringing the snacks?', time: 'Yesterday', avatarColor: '#009688' }]
        }
    };

    let currentChurchId = null;
    let churchData = null;
    let currentUser = { id: null, name: null };
    let notifications = [];
    let unreadNotifications = 0;
    let currentChat = null;
    const titles = { welcome: '‡§∏‡•ç‡§µ‡§æ‡§ó‡§§‡§Æ', live: '‡§Ü‡§∞‡§ß‡§®‡§æ', prayer: '‡§™‡•ç‡§∞‡§æ‡§∞‡•ç‡§•‡§®‡§æ', bible: '‡§¨‡§æ‡§á‡§¨‡§≤', news: '‡§∏‡•Å‡§ö‡§®‡§æ', chat: '‡§∏‡§Ç‡§ó‡§§‡§ø' };

    console.log("App script loaded.");

    // Initialize immediately
    initializeApp();

    function initializeApp() {
        console.log("Initializing...");
        setupEventListeners();

        const savedSessionJSON = localStorage.getItem('churchAppSession');
        if (savedSessionJSON) {
            try {
                const session = JSON.parse(savedSessionJSON);
                if (session && session.phone && mockUsers[session.phone]) {
                    loginSuccess(session.phone, true);
                } else {
                    showLogin();
                }
            } catch (e) {
                localStorage.removeItem('churchAppSession');
                showLogin();
            }
        } else {
            showLogin();
        }
    }

    function setupEventListeners() {
        // Login
        const loginForm = document.getElementById('login-form');
        const sendCodeBtn = document.getElementById('send-code-btn');

        if(loginForm) {
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                handleLoginClick();
            });
        }
        
        if(sendCodeBtn) {
            sendCodeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                handleLoginClick();
            });
        }

        const testNumbersContainer = document.querySelector('.test-numbers');
        if (testNumbersContainer) {
            testNumbersContainer.addEventListener('click', (e) => {
                const target = e.target.closest('.test-number-chip');
                if (target && target.dataset.phone) {
                    const phoneInput = document.getElementById('phone-input');
                    if(phoneInput) phoneInput.value = target.dataset.phone;
                    handleLoginClick();
                }
            });
        }

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const targetId = item.getAttribute('data-target');
                if (targetId) showContent(targetId);
            });
        });

        // Notifications & Menu
        const notificationBtn = document.getElementById('notification-btn');
        if(notificationBtn) notificationBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('notification-panel').classList.toggle('hidden');
            document.getElementById('more-menu-dropdown').classList.add('hidden');
            renderNotifications();
        });

        const moreMenuBtn = document.getElementById('more-menu-btn');
        if(moreMenuBtn) moreMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('more-menu-dropdown').classList.toggle('hidden');
            document.getElementById('notification-panel').classList.add('hidden');
        });

        document.addEventListener('click', (e) => {
            const target = e.target;
            const notifPanel = document.getElementById('notification-panel');
            const notifBtn = document.getElementById('notification-btn');
            const moreMenu = document.getElementById('more-menu-dropdown');
            const moreBtn = document.getElementById('more-menu-btn');

            if (notifPanel && !notifPanel.contains(target) && notifBtn && !notifBtn.contains(target)) {
                notifPanel.classList.add('hidden');
            }
            if (moreMenu && !moreMenu.contains(target) && moreBtn && !moreBtn.contains(target)) {
                moreMenu.classList.add('hidden');
            }
        });

        const dropdownLogoutBtn = document.getElementById('dropdown-logout-btn');
        if(dropdownLogoutBtn) dropdownLogoutBtn.addEventListener('click', logout);

        // Admin
        const dropdownAdminBtn = document.getElementById('dropdown-admin-btn');
        if(dropdownAdminBtn) dropdownAdminBtn.addEventListener('click', () => {
            document.getElementById('more-menu-dropdown').classList.add('hidden');
            if (currentUser && currentUser.isAdmin) {
                setupAdminPanel();
                document.getElementById('admin-panel-overlay').classList.remove('hidden');
            } else {
                alert('You do not have admin permissions.');
            }
        });

        const exitAdminModeBtn = document.getElementById('exit-admin-mode-btn');
        if(exitAdminModeBtn) exitAdminModeBtn.addEventListener('click', () => document.getElementById('admin-panel-overlay').classList.add('hidden'));

        // Chat
        const chatBackButton = document.getElementById('chat-back-btn');
        if(chatBackButton) chatBackButton.addEventListener('click', showChatList);
        const chatSendButton = document.getElementById('chat-send-btn');
        if(chatSendButton) chatSendButton.addEventListener('click', handleSendMessage);
        const chatInput = document.getElementById('chat-input');
        if(chatInput) chatInput.addEventListener('keydown', (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); }});
    }

    function handleLoginClick() {
        const phoneInput = document.getElementById('phone-input');
        const loginError = document.getElementById('login-error');
        if (!phoneInput) return;
        
        const phone = phoneInput.value.replace(/\D/g, '');
        console.log("Login attempt:", phone);

        if (!phone) {
            if(loginError) loginError.textContent = 'Please enter a number';
            return;
        }

        if (mockUsers[phone]) {
            loginSuccess(phone);
        } else {
            if(loginError) loginError.textContent = 'Number not found. Try 1234.';
            const loginModal = document.getElementById('login-modal');
            if (loginModal) {
                loginModal.classList.remove('shake');
                void loginModal.offsetWidth;
                loginModal.classList.add('shake');
            }
        }
    }

    function loginSuccess(phone, silent = false) {
        const userAuthData = mockUsers[phone];
        if (!userAuthData) return;

        currentChurchId = userAuthData.churchId;
        churchData = mockDatabase[currentChurchId];
        const loggedInUser = churchData.members.find(m => m.id === userAuthData.userId);
        currentUser = loggedInUser || { id: userAuthData.userId, name: userAuthData.name };

        localStorage.setItem('churchAppSession', JSON.stringify({ phone, userId: currentUser.id, churchId: currentChurchId }));

        const dropdownAdminBtn = document.getElementById('dropdown-admin-btn');
        if(dropdownAdminBtn) dropdownAdminBtn.style.display = currentUser.isAdmin ? 'block' : 'none';

        // FORCE HIDE
        const loginOverlay = document.getElementById('login-overlay');
        if(loginOverlay) {
            loginOverlay.classList.remove('active');
            loginOverlay.classList.add('hidden');
            loginOverlay.style.setProperty('display', 'none', 'important');
        }

        initializeForChurch();
        if(!silent) console.log("Login success");
    }

    function showLogin(message) {
        const loginOverlay = document.getElementById('login-overlay');
        if (loginOverlay) {
            loginOverlay.classList.remove('hidden');
            loginOverlay.classList.add('active');
            loginOverlay.style.removeProperty('display');
        }
        const phoneInput = document.getElementById('phone-input');
        if(phoneInput) phoneInput.value = '';
        const loginError = document.getElementById('login-error');
        if(loginError) loginError.textContent = message || '';
    }

    function logout() {
        localStorage.removeItem('churchAppSession');
        currentChurchId = null;
        churchData = null;
        currentUser = { id: null, name: null };
        document.getElementById('more-menu-dropdown').classList.add('hidden');
        showLogin();
    }

    function showContent(targetId) {
        if (!currentChurchId) return;

        const headerTitle = document.getElementById('header-title');
        if(headerTitle) {
            headerTitle.textContent = (targetId === 'welcome' ? churchData.name : titles[targetId]) || 'Welcome';
            headerTitle.classList.remove('is-group');
        }

        document.querySelectorAll('.content-section').forEach(section => section.classList.toggle('active', section.id === targetId));
        document.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.getAttribute('data-target') === targetId));

        if (targetId === 'chat') showChatList();
        if (targetId === 'live') setupLiveService();
        else {
            const iframe = document.getElementById('video-player');
            if(iframe) iframe.src = '';
        }
        if (targetId === 'bible') setupBiblePage();
    }

    function initializeForChurch() {
        if (!currentChurchId || !churchData) return;
        
        const welcomeChurchName = document.getElementById('welcome-church-name');
        const welcomeMessage = document.getElementById('welcome-message');
        if(welcomeChurchName) welcomeChurchName.textContent = `Welcome to ${churchData.name}!`;
        if(welcomeMessage) welcomeMessage.textContent = churchData.welcomeMessage;

        setupPrayerWall(); 
        setupNews(); 
        setupChatList();
        showContent('welcome');
        
        if(unreadNotifications === 0) {
            notifications = []; 
            addNotification(`Welcome to ${churchData.name}!`, 'system');
        }
    }

    // --- SUB-FUNCTIONS (Simplified for brevity but functional) ---
    function addNotification(message, type) {
        notifications.unshift({ message, type, timestamp: new Date() });
        unreadNotifications++;
        const badge = document.getElementById('notification-badge');
        if(badge) badge.classList.toggle('hidden', unreadNotifications <= 0);
    }

    function renderNotifications() {
        const list = document.getElementById('notification-list');
        if (!list) return;
        list.innerHTML = notifications.length === 0 ? `<li class="notification-item">No new notifications.</li>` : notifications.map(notif => `<li class="notification-item"><p>${notif.message}</p><small>${notif.timestamp.toLocaleString()}</small></li>`).join('');
        unreadNotifications = 0;
        document.getElementById('notification-badge').classList.add('hidden');
    }

    function setupLiveService() {
        const list = document.getElementById('sermon-list');
        if(!list || !churchData) return;
        list.innerHTML = '';
        churchData.sermons.forEach(sermon => {
            const li = document.createElement('li');
            li.className = 'sermon-list-item';
            li.dataset.videoId = sermon.videoId;
            li.innerHTML = `<div class="sermon-title">${sermon.title}</div><div class="sermon-meta">${sermon.speaker} - ${sermon.date}</div>`;
            li.onclick = () => loadVideo(sermon.videoId);
            list.appendChild(li);
        });
        const iframe = document.getElementById('video-player');
        if(iframe && !iframe.src.includes('youtube')) loadVideo(churchData.liveServiceVideoId);
    }

    function loadVideo(videoId) {
        const iframe = document.getElementById('video-player');
        if(iframe) iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1`;
        document.querySelectorAll('.sermon-list-item').forEach(el => el.classList.toggle('active', el.dataset.videoId === videoId));
    }

    function setupPrayerWall() {
        const list = document.getElementById('prayer-list');
        if(!list || !churchData) return;
        list.innerHTML = '';
        churchData.prayers.forEach(prayer => addPrayerToDOM(prayer));
    }

    function addPrayerToDOM(prayer) {
        const list = document.getElementById('prayer-list');
        if (!list) return;
        const card = document.createElement('div');
        card.className = 'prayer-card';
        const user = churchData.members.find(m => m.id === prayer.postedBy) || { name: 'Unknown', avatarColor: '#ccc' };
        card.innerHTML = `<div class="prayer-card-header"><div class="prayer-card-avatar" style="background-color: ${user.avatarColor};">${user.name.charAt(0).toUpperCase()}</div><div class="prayer-card-userinfo"><span class="prayer-card-username">${user.name}</span><span class="prayer-card-time">${new Date(prayer.timestamp).toLocaleDateString()}</span></div></div><div class="prayer-card-content"><h3>${prayer.title}</h3><p>${prayer.text}</p></div><div class="prayer-card-actions"><button class="action-btn prayed-btn">üôè <span class="prayed-count">${prayer.prayedCount}</span></button></div>`;
        card.querySelector('.prayed-btn').addEventListener('click', function() {
            const count = this.querySelector('.prayed-count');
            if(!this.classList.contains('prayed')) {
                count.textContent = (parseInt(count.textContent||'0') + 1).toString();
                this.classList.add('prayed');
            }
        });
        list.appendChild(card);
    }

    function setupNews() {
        const list = document.getElementById('news-list');
        if(!list || !churchData) return;
        list.innerHTML = '';
        churchData.news.forEach(item => {
            const d = document.createElement('div');
            d.className = 'news-card';
            d.innerHTML = `<h3>${item.title}</h3><p>${item.text}</p><span class="news-date">${item.date}</span>`;
            list.appendChild(d);
        });
    }

    function setupBiblePage() {
        const container = document.getElementById('bible-reading-plan');
        if(!container || container.children.length > 0) return;
        const today = new Date();
        const start = new Date(today.getFullYear(), 0, 0);
        const dayOfYear = Math.floor((today.getTime() - start.getTime()) / 86400000);
        for(let i=1; i<=365; i++) {
            const div = document.createElement('div');
            div.className = 'reading-plan-item' + (i === dayOfYear ? ' today' : '');
            div.textContent = `Day ${i}`;
            div.onclick = () => alert(`Day ${i} Reading content would appear here.`);
            container.appendChild(div);
            if(i===dayOfYear) setTimeout(()=>div.scrollIntoView({block:'center'}), 100);
        }
        document.getElementById('daily-life-date').textContent = today.toLocaleDateString();
    }

    function setupChatList() {
        const container = document.getElementById('chat-list-container');
        if(!container || !churchData) return;
        container.innerHTML = '';
        churchData.chats.forEach(chat => {
            const el = document.createElement('div');
            el.className = 'chat-list-item';
            const name = chat.type === 'direct' ? (churchData.members.find(m => m.id === chat.members.find(mid => mid !== currentUser.id))?.name || 'User') : chat.name;
            el.innerHTML = `<div class="chat-avatar" style="background-color: ${chat.avatarColor};">${name.charAt(0)}</div><div class="chat-list-details"><div class="chat-list-title">${name}</div><div class="chat-list-preview">${chat.preview}</div></div>`;
            el.onclick = () => showChatDetail(chat, name);
            container.appendChild(el);
        });
    }

    function showChatDetail(chat, name) {
        currentChat = chat;
        document.querySelectorAll('.active').forEach(e => e.classList.remove('active'));
        document.getElementById('chat-detail-view').classList.add('active');
        document.getElementById('chat-detail-title').textContent = name;
        const msgs = document.querySelector('.chat-messages');
        if(msgs) {
            msgs.innerHTML = `<div class="message-bubble other">Welcome to ${name} chat!</div>`;
        }
    }

    function showChatList() {
        document.querySelectorAll('.active').forEach(e => e.classList.remove('active'));
        document.getElementById('chat').classList.add('active'); 
        document.getElementById('chat-list-view').classList.add('active');
        document.getElementById('header-title').textContent = titles['chat'];
    }

    function handleSendMessage() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if(!text) return;
        const msgs = document.querySelector('.chat-messages');
        if(msgs) {
            const b = document.createElement('div');
            b.className = 'message-bubble me';
            b.textContent = text;
            msgs.appendChild(b);
            msgs.scrollTop = msgs.scrollHeight;
        }
        input.value = '';
    }

    function setupAdminPanel() {
        const list = document.getElementById('admin-members-list');
        if(list && churchData) {
            list.innerHTML = '';
            churchData.members.forEach(m => {
                const li = document.createElement('li');
                li.className = 'admin-list-item';
                li.innerHTML = `<p>${m.name}</p><button class="admin-delete-btn">Remove</button>`;
                list.appendChild(li);
            });
        }
    }
    </script>
</body>
</html>